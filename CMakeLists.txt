# è®¾ç½®æœ€ä½ç‰ˆæœ¬å’Œé¡¹ç›®åç§°
cmake_minimum_required(VERSION 3.15)
project(muduo-core LANGUAGES CXX)

# è®¾ç½®å…¨å±€ C++ æ ‡å‡†
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# å¯ç”¨æµ‹è¯•
enable_testing()

# è¾“å‡ºè·¯å¾„
set(LIBRARY_OUTPUT_PATH ${PROJECT_SOURCE_DIR}/lib)
set(LIBS pthread)

# ----------------------------
# ç¼–è¯‘é€‰é¡¹ï¼šå…¨å±€è­¦å‘Šæ§åˆ¶
# ----------------------------
if (CMAKE_CXX_COMPILER_ID MATCHES "GNU|Clang")
    add_compile_options(
        -Wall
        -Wextra
        -Wpedantic
        -Wshadow
        -Wconversion
        -Wold-style-cast
        -Wcast-align
        -Wunused
        -Wnull-dereference
        -Wdouble-promotion
        -Wformat=2
        -Wno-unused-parameter
        -Wno-sign-conversion
        -Wnon-virtual-dtor
        -Wno-sign-conversion       # å…è®¸æœ‰ç¬¦å·/æ— ç¬¦å·æ··åˆ
        -Wno-implicit-float-conversion  # æ”¾å®½æµ®ç‚¹ç²¾åº¦è­¦å‘Š
        -Werror
    )
elseif (CMAKE_CXX_COMPILER_ID STREQUAL "MSVC")
    add_compile_options(
        /W4 /permissive- /Zc:__cplusplus /EHsc /utf-8
        /D_CRT_SECURE_NO_WARNINGS
    )
endif()

# ----------------------------
# é»˜è®¤æ„å»ºç±»å‹ï¼ˆDebug ä¼˜å…ˆï¼‰
# ----------------------------
if (NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Debug CACHE STRING "Choose Release or Debug" FORCE)
endif()
# ----------------------------
# AddressSanitizer é…ç½® (ä»… Debug æ¨¡å¼)
# ----------------------------
if (CMAKE_BUILD_TYPE STREQUAL "Debug")
    message(STATUS "ğŸ” Enabling AddressSanitizer (ASan) for Debug build")
    add_compile_options(-fsanitize=address -fno-omit-frame-pointer -g)
    add_link_options(-fsanitize=address)
endif()

# ----------------------------
# æ·»åŠ å­ç›®å½•
# ----------------------------
add_subdirectory(apps/order_server)
add_subdirectory(base)
add_subdirectory(cache)
add_subdirectory(core)
add_subdirectory(db)
add_subdirectory(logger)
add_subdirectory(mq)
add_subdirectory(net)
add_subdirectory(tests)
